{
  "name": "EvaRoomBot - Telegram Verification Bot",
  "nodes": [
    {
      "parameters": {
        "updates": ["message", "callback_query"]
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "eva-room-bot",
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// FSM - Finite State Machine for session management\nconst userId = $json.message?.from?.id || $json.callback_query?.from?.id;\nconst messageText = $json.message?.text || '';\nconst callbackData = $json.callback_query?.data || '';\n\n// Initialize or get session state\nconst sessionKey = `session_${userId}`;\nlet sessionState = await $getWorkflowStaticData('global')[sessionKey] || {\n  state: 'IDLE',\n  data: {},\n  timestamp: Date.now()\n};\n\n// Determine input type and content\nlet inputType = 'unknown';\nlet inputContent = '';\n\nif (messageText.startsWith('/')) {\n  inputType = 'command';\n  inputContent = messageText;\n} else if (callbackData) {\n  inputType = 'button';\n  inputContent = callbackData;\n} else if (messageText) {\n  inputType = 'text';\n  inputContent = messageText;\n}\n\n// Output enhanced data\nreturn {\n  json: {\n    userId,\n    inputType,\n    inputContent,\n    sessionState,\n    originalMessage: $json.message,\n    originalCallback: $json.callback_query,\n    chatId: $json.message?.chat?.id || $json.callback_query?.message?.chat?.id\n  }\n};"
      },
      "id": "session-state",
      "name": "Session State Manager",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.inputType}}",
              "operation": "equals",
              "value2": "command"
            }
          ]
        }
      },
      "id": "router-command",
      "name": "Router - Command",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 200]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.inputType}}",
              "operation": "equals",
              "value2": "button"
            }
          ]
        }
      },
      "id": "router-button",
      "name": "Router - Button",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 350]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.inputType}}",
              "operation": "equals",
              "value2": "text"
            }
          ]
        }
      },
      "id": "router-text",
      "name": "Router - Text",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 500]
    },
    {
      "parameters": {
        "functionCode": "// Parse command and route accordingly\nconst command = $json.inputContent;\nconst sessionState = $json.sessionState;\n\nif (command === '/start') {\n  sessionState.state = 'IDLE';\n  sessionState.data = {};\n  return {\n    json: {\n      ...$json,\n      command: 'start',\n      sessionState,\n      responseText: 'üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ EvaRoomBot!\\n\\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏:\\n1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ (–ò–ù–ù/–û–ì–†–ù)\\n2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–ª–∏—Ü–∞ (–§–ò–û, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è)\\n3Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞',\n      keyboard: [\n        [{ text: 'üè¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞', callback_data: 'check_company' }],\n        [{ text: 'üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–ª–∏—Ü–∞', callback_data: 'check_individual' }],\n        [{ text: 'üìÑ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞', callback_data: 'validate_contract' }],\n        [{ text: '‚ÑπÔ∏è –ü–æ–º–æ—â—å', callback_data: 'help' }]\n      ]\n    }\n  };\n} else if (command === '/help') {\n  return {\n    json: {\n      ...$json,\n      command: 'help',\n      responseText: 'üìñ –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞:\\n\\n/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\\n/check - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞\\n/status - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å\\n/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É'\n    }\n  };\n} else if (command === '/check') {\n  sessionState.state = 'AWAITING_INN';\n  return {\n    json: {\n      ...$json,\n      command: 'check',\n      sessionState,\n      responseText: 'üîç –í–≤–µ–¥–∏—Ç–µ –ò–ù–ù –∏–ª–∏ –û–ì–†–ù –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:'\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...$json,\n    command: 'unknown',\n    responseText: '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏.'\n  }\n};"
      },
      "id": "command-handler",
      "name": "Command Handler",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 150]
    },
    {
      "parameters": {
        "functionCode": "// Handle button callbacks\nconst callbackData = $json.inputContent;\nconst sessionState = $json.sessionState;\n\nif (callbackData === 'check_company') {\n  sessionState.state = 'AWAITING_INN';\n  sessionState.data.checkType = 'company';\n  return {\n    json: {\n      ...$json,\n      action: 'check_company',\n      sessionState,\n      responseText: 'üè¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞\\n\\n–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä) –∏–ª–∏ –û–ì–†–ù (13 –∏–ª–∏ 15 —Ü–∏—Ñ—Ä):'\n    }\n  };\n} else if (callbackData === 'check_individual') {\n  sessionState.state = 'AWAITING_INDIVIDUAL_DATA';\n  sessionState.data.checkType = 'individual';\n  return {\n    json: {\n      ...$json,\n      action: 'check_individual',\n      sessionState,\n      responseText: 'üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞\\n\\n–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\\n–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ, –î–î.–ú–ú.–ì–ì–ì–ì, –ò–ù–ù\\n\\n–ü—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á, 01.01.1990, 123456789012'\n    }\n  };\n} else if (callbackData === 'validate_contract') {\n  sessionState.state = 'AWAITING_CONTRACT_DATA';\n  sessionState.data.checkType = 'contract';\n  return {\n    json: {\n      ...$json,\n      action: 'validate_contract',\n      sessionState,\n      responseText: 'üìÑ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞\\n\\n–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–æ–≥–æ–≤–æ—Ä–∞:\\n–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞, –î–∞—Ç–∞, –°—É–º–º–∞\\n\\n–ü—Ä–∏–º–µ—Ä: –î-12345, 01.12.2024, 100000'\n    }\n  };\n} else if (callbackData === 'help') {\n  return {\n    json: {\n      ...$json,\n      action: 'help',\n      responseText: 'üìñ –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞:\\n\\n–ë–æ—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤, —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–æ–≥–æ–≤–æ—Ä–æ–≤.\\n\\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏.'\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...$json,\n    action: 'unknown',\n    responseText: '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.'\n  }\n};"
      },
      "id": "button-handler",
      "name": "Button Handler",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 350]
    },
    {
      "parameters": {
        "functionCode": "// Handle text input based on current state\nconst text = $json.inputContent;\nconst sessionState = $json.sessionState;\nconst currentState = sessionState.state;\n\nif (currentState === 'AWAITING_INN') {\n  // Validate INN/OGRN format\n  const innOgrnPattern = /^\\d{10}$|^\\d{12}$|^\\d{13}$|^\\d{15}$/;\n  if (!innOgrnPattern.test(text.trim())) {\n    return {\n      json: {\n        ...$json,\n        error: true,\n        responseText: '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ò–ù–ù/–û–ì–†–ù.\\n\\n–ò–ù–ù: 10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä\\n–û–ì–†–ù: 13 –∏–ª–∏ 15 —Ü–∏—Ñ—Ä\\n\\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:'\n      }\n    };\n  }\n  \n  sessionState.data.inn_ogrn = text.trim();\n  sessionState.state = 'PROCESSING';\n  \n  return {\n    json: {\n      ...$json,\n      sessionState,\n      inn_ogrn: text.trim(),\n      needsDaDataLookup: true,\n      responseText: 'üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...'\n    }\n  };\n} else if (currentState === 'AWAITING_INDIVIDUAL_DATA') {\n  // Parse individual data\n  const parts = text.split(',').map(p => p.trim());\n  if (parts.length !== 3) {\n    return {\n      json: {\n        ...$json,\n        error: true,\n        responseText: '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.\\n\\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç:\\n–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ, –î–î.–ú–ú.–ì–ì–ì–ì, –ò–ù–ù\\n\\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:'\n      }\n    };\n  }\n  \n  const [fullName, birthDate, inn] = parts;\n  sessionState.data.fullName = fullName;\n  sessionState.data.birthDate = birthDate;\n  sessionState.data.inn = inn;\n  sessionState.state = 'PROCESSING';\n  \n  return {\n    json: {\n      ...$json,\n      sessionState,\n      fullName,\n      birthDate,\n      inn,\n      needsDaDataLookup: true,\n      responseText: 'üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞...'\n    }\n  };\n} else if (currentState === 'AWAITING_CONTRACT_DATA') {\n  // Parse contract data\n  const parts = text.split(',').map(p => p.trim());\n  if (parts.length !== 3) {\n    return {\n      json: {\n        ...$json,\n        error: true,\n        responseText: '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–∞.\\n\\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç:\\n–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞, –î–∞—Ç–∞, –°—É–º–º–∞\\n\\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:'\n      }\n    };\n  }\n  \n  const [contractNumber, contractDate, amount] = parts;\n  sessionState.data.contractNumber = contractNumber;\n  sessionState.data.contractDate = contractDate;\n  sessionState.data.amount = amount;\n  sessionState.state = 'PROCESSING';\n  \n  return {\n    json: {\n      ...$json,\n      sessionState,\n      contractNumber,\n      contractDate,\n      amount,\n      needsContractValidation: true,\n      responseText: 'üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞...'\n    }\n  };\n}\n\nreturn {\n  json: {\n    ...$json,\n    responseText: '‚ùì –Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.'\n  }\n};"
      },
      "id": "text-handler",
      "name": "Text Input Handler",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 550]
    },
    {
      "parameters": {
        "url": "https://suggestions.dadata.ru/suggestions/api/4_1/rs/findById/party",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{$json.inn_ogrn}}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": false
            }
          }
        }
      },
      "id": "dadata-find-company",
      "name": "DaData Find Company",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "2",
          "name": "DaData API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Calculate scoring based on DaData response\nconst companyData = $json.suggestions?.[0]?.data || {};\n\nlet score = 100;\nlet riskLevel = 'LOW';\nlet recommendations = [];\nlet details = [];\n\n// Check company status\nif (companyData.state?.status === 'LIQUIDATING') {\n  score -= 50;\n  riskLevel = 'CRITICAL';\n  recommendations.push('‚õî –ö–æ–º–ø–∞–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏');\n  details.push('–°—Ç–∞—Ç—É—Å: –õ–∏–∫–≤–∏–¥–∞—Ü–∏—è');\n} else if (companyData.state?.status === 'LIQUIDATED') {\n  score -= 70;\n  riskLevel = 'CRITICAL';\n  recommendations.push('‚õî –ö–æ–º–ø–∞–Ω–∏—è –ª–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–∞');\n  details.push('–°—Ç–∞—Ç—É—Å: –õ–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–∞');\n} else if (companyData.state?.status === 'REORGANIZING') {\n  score -= 30;\n  riskLevel = 'HIGH';\n  recommendations.push('‚ö†Ô∏è –ö–æ–º–ø–∞–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏');\n  details.push('–°—Ç–∞—Ç—É—Å: –†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è');\n} else if (companyData.state?.status === 'ACTIVE') {\n  details.push('–°—Ç–∞—Ç—É—Å: ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞');\n} else {\n  score -= 20;\n  riskLevel = 'MEDIUM';\n  details.push('–°—Ç–∞—Ç—É—Å: –ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω');\n}\n\n// Check registration date (newer companies = higher risk)\nif (companyData.state?.registration_date) {\n  const regDate = new Date(companyData.state.registration_date);\n  const monthsSinceReg = (Date.now() - regDate.getTime()) / (1000 * 60 * 60 * 24 * 30);\n  \n  if (monthsSinceReg < 6) {\n    score -= 25;\n    if (riskLevel === 'LOW') riskLevel = 'MEDIUM';\n    recommendations.push('‚ö†Ô∏è –ö–æ–º–ø–∞–Ω–∏—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –º–µ–Ω–µ–µ 6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥');\n  } else if (monthsSinceReg < 12) {\n    score -= 15;\n    if (riskLevel === 'LOW') riskLevel = 'MEDIUM';\n    recommendations.push('‚ö†Ô∏è –ö–æ–º–ø–∞–Ω–∏—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –º–µ–Ω–µ–µ –≥–æ–¥–∞ –Ω–∞–∑–∞–¥');\n  }\n  \n  details.push(`–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${regDate.toLocaleDateString('ru-RU')}`);\n}\n\n// Check authorized capital\nif (companyData.capital?.value) {\n  const capital = parseFloat(companyData.capital.value);\n  if (capital < 10000) {\n    score -= 15;\n    if (riskLevel === 'LOW') riskLevel = 'MEDIUM';\n    recommendations.push('‚ö†Ô∏è –ù–∏–∑–∫–∏–π —É—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª');\n  }\n  details.push(`–£—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª: ${capital.toLocaleString('ru-RU')} —Ä—É–±.`);\n}\n\n// Check OKVED (main activity)\nif (companyData.okved) {\n  details.push(`–û—Å–Ω–æ–≤–Ω–æ–π –û–ö–í–≠–î: ${companyData.okved}`);\n}\n\n// Check management\nif (companyData.management?.name) {\n  details.push(`–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å: ${companyData.management.name}`);\n}\n\n// Check address\nif (companyData.address?.value) {\n  details.push(`–ê–¥—Ä–µ—Å: ${companyData.address.value}`);\n  \n  // Mass registration address check\n  if (companyData.address?.data?.qc_geo === '4' || companyData.address?.data?.qc_geo === '5') {\n    score -= 20;\n    if (riskLevel === 'LOW') riskLevel = 'MEDIUM';\n    recommendations.push('‚ö†Ô∏è –ê–¥—Ä–µ—Å –º–∞—Å—Å–æ–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');\n  }\n}\n\n// Final score adjustment\nscore = Math.max(0, Math.min(100, score));\n\n// Determine risk level based on final score\nif (score >= 80) {\n  riskLevel = 'LOW';\n} else if (score >= 60) {\n  riskLevel = 'MEDIUM';\n} else if (score >= 40) {\n  riskLevel = 'HIGH';\n} else {\n  riskLevel = 'CRITICAL';\n}\n\nif (recommendations.length === 0) {\n  recommendations.push('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');\n}\n\nconst companyName = companyData.name?.short_with_opf || companyData.name?.full || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è';\nconst inn = companyData.inn || $json.inn_ogrn;\nconst ogrn = companyData.ogrn || '';\n\nreturn {\n  json: {\n    ...$json,\n    score,\n    riskLevel,\n    recommendations,\n    details,\n    companyName,\n    inn,\n    ogrn,\n    fullCompanyData: companyData\n  }\n};"
      },
      "id": "calculate-scoring",
      "name": "Calculate Scoring",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "functionCode": "// Format result for Telegram message\nconst score = $json.score || 0;\nconst riskLevel = $json.riskLevel || 'UNKNOWN';\nconst recommendations = $json.recommendations || [];\nconst details = $json.details || [];\nconst companyName = $json.companyName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è';\nconst inn = $json.inn || '';\nconst ogrn = $json.ogrn || '';\n\n// Risk level emoji and text\nconst riskEmoji = {\n  'LOW': 'üü¢',\n  'MEDIUM': 'üü°',\n  'HIGH': 'üü†',\n  'CRITICAL': 'üî¥',\n  'UNKNOWN': '‚ö™'\n};\n\nconst riskText = {\n  'LOW': '–ù–∏–∑–∫–∏–π',\n  'MEDIUM': '–°—Ä–µ–¥–Ω–∏–π',\n  'HIGH': '–í—ã—Å–æ–∫–∏–π',\n  'CRITICAL': '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π',\n  'UNKNOWN': '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'\n};\n\n// Score emoji\nconst scoreEmoji = score >= 80 ? 'üü¢' : score >= 60 ? 'üü°' : score >= 40 ? 'üü†' : 'üî¥';\n\n// Build message\nlet message = `üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞**\\n\\n`;\nmessage += `üè¢ **–ö–æ–º–ø–∞–Ω–∏—è:** ${companyName}\\n`;\nif (inn) message += `üî¢ **–ò–ù–ù:** ${inn}\\n`;\nif (ogrn) message += `üî¢ **–û–ì–†–ù:** ${ogrn}\\n`;\nmessage += `\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\nmessage += `${scoreEmoji} **–°–∫–æ—Ä–∏–Ω–≥–æ–≤—ã–π –±–∞–ª–ª:** ${score}/100\\n`;\nmessage += `${riskEmoji[riskLevel]} **–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:** ${riskText[riskLevel]}\\n`;\nmessage += `\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n\nif (details.length > 0) {\n  message += `üìã **–î–µ—Ç–∞–ª–∏:**\\n`;\n  details.forEach(detail => {\n    message += `‚Ä¢ ${detail}\\n`;\n  });\n  message += `\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n}\n\nif (recommendations.length > 0) {\n  message += `üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**\\n`;\n  recommendations.forEach(rec => {\n    message += `${rec}\\n`;\n  });\n}\n\nmessage += `\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmessage += `\\nüîÑ –î–ª—è –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start`;\n\n// Reset session state\nconst sessionState = $json.sessionState || {};\nsessionState.state = 'IDLE';\nsessionState.data = {};\n\nreturn {\n  json: {\n    ...$json,\n    responseText: message,\n    sessionState,\n    keyboard: [\n      [{ text: 'üîÑ –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞', callback_data: 'check_company' }],\n      [{ text: 'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data: 'start' }]\n    ]\n  }\n};"
      },
      "id": "format-result",
      "name": "Format Result",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "={{$json.responseText}}",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": "={{JSON.stringify({ inline_keyboard: $json.keyboard || [] })}}"
      },
      "id": "send-telegram-message",
      "name": "Send Telegram Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1650, 300],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Save session state back to workflow static data\nconst userId = $json.userId;\nconst sessionState = $json.sessionState;\nconst sessionKey = `session_${userId}`;\n\nconst staticData = $getWorkflowStaticData('global');\nstaticData[sessionKey] = sessionState;\n\nreturn { json: $json };"
      },
      "id": "save-session",
      "name": "Save Session State",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1850, 300]
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Session State Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session State Manager": {
      "main": [
        [
          {
            "node": "Router - Command",
            "type": "main",
            "index": 0
          },
          {
            "node": "Router - Button",
            "type": "main",
            "index": 0
          },
          {
            "node": "Router - Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router - Command": {
      "main": [
        [
          {
            "node": "Command Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router - Button": {
      "main": [
        [
          {
            "node": "Button Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router - Text": {
      "main": [
        [
          {
            "node": "Text Input Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Command Handler": {
      "main": [
        [
          {
            "node": "Send Telegram Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Button Handler": {
      "main": [
        [
          {
            "node": "Send Telegram Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text Input Handler": {
      "main": [
        [
          {
            "node": "DaData Find Company",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DaData Find Company": {
      "main": [
        [
          {
            "node": "Calculate Scoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Scoring": {
      "main": [
        [
          {
            "node": "Format Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Result": {
      "main": [
        [
          {
            "node": "Send Telegram Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Telegram Message": {
      "main": [
        [
          {
            "node": "Save Session State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-12-06T00:00:00.000Z",
  "versionId": "1"
}
